name: Nix CI
"on":
  pull_request: {}
  push: {}
  workflow_dispatch: {}

jobs:
  nixCI:
    name: Nix CI
    permissions:
      actions: write
      contents: write
    strategy:
        matrix:
          os:
            - macos-15
            - ubuntu-24.04
            - ubuntu-24.04-arm
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v6.0.1
      - name: Install Nix
        uses: nixbuild/nix-quick-install-action@v34
        with:
          nix_conf: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            substituters = https://cache.nixos.org/ https://nix-community.cachix.org https://cache.iog.io
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=
      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ matrix.os }}-job-${{ hashfiles('**/flake.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ matrix.os }}-job-
          gc-max-store-size: 5G
      - if: matrix.os == 'ubuntu-24.04'
        name: Configure git for github-actions
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions@github.com
      - if: matrix.os == 'ubuntu-24.04'
        name: Format Nix files
        run: nix run .#format
      - if: matrix.os == 'ubuntu-24.04'
        name: Write docs
        run: nix run .#writeDocs
      - if: matrix.os == 'ubuntu-24.04'
        name: Commit & Push changes
        run: |-
          git pull --rebase --autostash

          git add .

          git commit \
            -m "action" \
            -m "Format Nix files" \
            -m "Write docs" \
            || echo "commit failed!"

          git push
      - name: Build lima
        run: nix build .#lima
      - name: Build lima sdist
        run: nix build .#sdist
      - name: Save from GC
        run: nix profile install .#saveFromGC